
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Rails on Maui</title>
  <meta name="author" content="Justin Gordon">

  
  <meta name="description" content="How do ensure that your application properly handles errors, especially when
relying on third parties, such as payment processors? Is it easy to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.railsonmaui.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/railsonmaui" rel="alternate" title="Rails on Maui" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40522944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Rails on Maui</a></h1>
  
    <h2>Programming in Paradise or Paradise in Programming?</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="http://feeds.feedburner.com/railsonmaui" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="http://feedburner.google.com/fb/a/mailverify?uri=RailsOnMaui&amp;loc=en_US" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.railsonmaui.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/tips">Tips</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/meta">Meta</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/11/testing-error-conditions-in-payment-processing/">Testing Error Handling of Payment Processing: Unit and Integration</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-11T00:01:00-10:00" pubdate data-updated="true">May 11<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/11/testing-error-conditions-in-payment-processing/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
How do ensure that your application properly handles errors, especially when
relying on third parties, such as payment processors? Is it easy to verify that
the right things happen when the wrong things happen? Last week&#8217;s article
<a href="http:/blog/2013/05/08/saner-rails-logging/">Strategies for Rails Logging and Error Handling </a> discussed some techniques to
setup a good error handling strategy. Here&#8217;s some techniques to verify that your
application does what you expect it to do when things go wrong. The key message
is to check how your application handles errors, before your customers do.
</p>




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Your Code Depends on Outside Systems (That Might Raise Errors)</a></li>
<li><a href="#sec-2">2 Verification of Error Handling Strategy</a></li>
<li><a href="#sec-3">3 Payment Processing is Like a 2-Phase Commit</a></li>
<li><a href="#sec-4">4 Brute Force Methodology</a></li>
<li><a href="#sec-5">5 RSpec Unit Testing of Errors</a></li>
<li><a href="#sec-6">6 RSpec Capybara Feature (Integration) Tests of UI Errors</a></li>
<li><a href="#sec-7">7 Conclusion</a></li>
</ul>
</div>
</div>




<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Your Code Depends on Outside Systems (That Might Raise Errors)</h2>
<div class="outline-text-2" id="text-1">

<p>Suppose you&#8217;ve created the super-duper Rails storefront application that takes
online payments. You may even have some unit tests that verify the code. Then
you get the dreaded call that customers are being charged twice and their
orders are not processed. WTF?
</p>
<p>
It&#8217;s not entirely obvious how to verify proper error handling when outside
systems fail, or even when odd errors are raised from your own code. Payment
processing deserves some special attention because it&#8217;s a dependency on an
outside service (the payment processor) and will typically require database
updates based on the result of the payment processing. If you&#8217;re updating
several tables, then you&#8217;ll want to use a transaction to ensure that all or
nothing saves. While code review and manual testing are good first steps, you
should consider a few extra steps with error handling for sensitive parts of
your application.
</p>

</div>

</div>




<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">Verification of Error Handling Strategy</h2>
<div class="outline-text-2" id="text-2">

<p>Typically, error handling code is not well tested. It&#8217;s much more common to test
the &#8220;happy path&#8221; of everything going right.
</p>
<p>
Let&#8217;s look at hypothetical example and some tests that can flush out some
errors.
</p>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Order</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">purchase_cart</span>
</span><span class='line'>    <span class="n">error_message</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="no">Order</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># self.user record has charge info, and self.total is the order total</span>
</span><span class='line'>      <span class="c1"># PaymentGateway.charge returns either error_message if failed or charge_details if success</span>
</span><span class='line'>      <span class="n">error_message</span><span class="p">,</span> <span class="n">charge_details</span> <span class="o">=</span> <span class="no">PaymentGateway</span><span class="o">.</span><span class="n">charge</span> <span class="n">user</span><span class="p">,</span> <span class="n">total</span>
</span><span class='line'>      <span class="c1"># update the order and the user records with the charge_details</span>
</span><span class='line'>      <span class="n">set_charge_fields_and_save</span> <span class="n">user</span><span class="p">,</span> <span class="n">charge_details</span> <span class="k">unless</span> <span class="n">error_message</span> <span class="c1"># update the order to indicated purchased</span>
</span><span class='line'>      <span class="n">fulfill_order</span> <span class="c1"># do lots of complicated stuff to fulfill the order</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">error_message</span> <span class="c1"># return any error message if there is one</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
So what can go wrong?
</p>
</div>

</div>




<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Payment Processing is Like a 2-Phase Commit</h2>
<div class="outline-text-2" id="text-3">

<p>Conceptually, you want a transaction, such that it&#8217;s all or nothing. If the
charge goes through, then so does everything else. Payment processing like a
2-phase commit, except one has to handle all the what-ifs to be sure that it&#8217;s
handled correctly.
</p>
<p>
The general steps of payment processing are like this:
</p><ol>
<li>Connect to outside resource to make charge.
</li>
<li>Update database records indicating charge successful.
</li>
<li>Fulfill the order.
</li>
</ol>


<p>
Rails transactions work such than any exception in the block will cause the
transaction to be rolled back. The problem with the above code is what happens
if fulfill_order throws an exception? The customer has been charged, the order
was updated to reflect payment, but then <b>ka-boom</b> and an exception is raised,
and any database updates to the order are rolled back, <b>but the payment is not refunded</b>. The customer is confused as there is a charge but nothing else. How
could you have tested (and avoided) this?
</p>
</div>

</div>




<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Brute Force Methodology</h2>
<div class="outline-text-2" id="text-4">

<p>You can simulate error conditions by manually placing =raise &#8220;any error message&#8221;=
statements in your code, and then testing, say in the UI manually. This is a
good first step to verify that your error handling is working correctly. You
might raise a specific error, if say your payment processor throws a specific
type of error.
</p>
<p>
For the above example, the different methods referenced, such as <code>process_order</code>
can get modified with a single line at the beginning, which would be:
</p>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">process_order</span>
</span><span class='line'>  <span class="k">raise</span> <span class="s2">&quot;Any error message&quot;</span>
</span><span class='line'>  <span class="c1"># Lots of other code that can be commented out</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Then go into the UI and test placing an order. Consider the following questions:
</p><ol>
<li>Was the right error message displayed to the user?
</li>
<li>Was the right information logged at the correct log level?
</li>
<li>Was an automatic email sent regarding the error? 
</li>
</ol>


<p>
See my prior article <a href="http:/blog/2013/05/08/saner-rails-logging/">Saner Rails Logging</a> for the answers to #2 and #3.
</p>
<p>
By applying this technique to each of the components of completing a purchase,
one can flush out (and handle) nearly all of the different possible errors that
could affect a purchase. Give this technique a try in some critical section of
the code. You&#8217;ll be surprised how well it works. Before giving you the fix to
the above code, let&#8217;s see if we can write unit and feature tests on our error
handling.
</p>
</div>

</div>




<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">RSpec Unit Testing of Errors</h2>
<div class="outline-text-2" id="text-5">

<p>It turns out that with stubbing in <code>rspec</code>, it&#8217;s easy to test error handling!
<a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-13/docs/method-stubs">RSpec provides a nice mocking library</a>. The test code would look something like
this. Pay attention to the call to <b>stub</b>.
</p>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Order</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#purchase_cart&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;process_order fails&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:order</span> <span class="p">}</span> <span class="c1"># factory_girl creation of order and related objects</span>
</span><span class='line'>      <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>        <span class="c1"># The magic stubbing of every instance</span>
</span><span class='line'>        <span class="no">Order</span><span class="o">.</span><span class="n">any_instance</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:fulfill_order</span><span class="p">)</span> <span class="p">{</span> <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;test error&quot;</span> <span class="p">}</span>
</span><span class='line'>        <span class="c1"># The call to purchase_cart will first call &#39;charge&#39;</span>
</span><span class='line'>        <span class="no">PaymentGateway</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:charge</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;charge_details&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># The error from within purchase_cart should do a refund</span>
</span><span class='line'>        <span class="no">PaymentGateway</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:refund</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s2">&quot;refund_details&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should throw an error&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">expect</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">order</span><span class="o">.</span><span class="n">purchase_cart</span>
</span><span class='line'>        <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span>
</span><span class='line'>        <span class="n">order</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'>        <span class="n">order</span><span class="o">.</span><span class="n">purchased</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be</span>
</span><span class='line'>        <span class="c1"># charge refunded verified in mock</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
This test code ensures that the error handling of purchase_cart will catch an
error from fulfill_order, and properly refund the payment and rollback any
changes to the order record.
</p>
<p>
Here&#8217;s an improved version of the Order#payment_method above:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Order</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">purchase_cart</span>
</span><span class='line'>    <span class="n">error_message</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="no">Order</span><span class="o">.</span><span class="n">transaction</span> <span class="k">do</span>
</span><span class='line'>        <span class="c1"># user has a credit card info, returns either error_message if failed or charge_details if success</span>
</span><span class='line'>        <span class="n">error_message</span><span class="p">,</span> <span class="n">charge_details</span> <span class="o">=</span> <span class="no">PaymentGateway</span><span class="o">.</span><span class="n">charge</span> <span class="n">user</span><span class="p">,</span> <span class="n">total</span>
</span><span class='line'>        <span class="n">set_charge_fields_and_save</span> <span class="n">user</span><span class="p">,</span> <span class="n">charge_details</span> <span class="k">unless</span> <span class="n">error_message</span> <span class="c1"># update the order to indicated purchased</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">fulfill_order</span> <span class="c1"># do lots of complicated stuff to process the order, do this outside of the original tx, so that the payment info can be committed.</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="no">Utility</span><span class="o">.</span><span class="n">log_exception</span> <span class="n">e</span> <span class="c1"># Unified strategy for error handling including email notification, see below</span>
</span><span class='line'>      <span class="n">refund_charge</span> <span class="k">if</span> <span class="n">charge_details</span> <span class="c1"># If there&#39;s an error here, then sys admins will have to manually refund the charge.</span>
</span><span class='line'>      <span class="kp">throw</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">error_message</span> <span class="c1"># return any error message if there is one</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


Here are the key points to the improved code:
</p><ol>
<li>There&#8217;s a block to catch the exception which is <i>separate from the    transaction block</i>. The <code>rescue</code> properly handles the case of an a charge
   being made and needing to be refunded. <code>Utility.log_exception</code> will ensure
   that all the right things happen with this sort of error (see <a href="http:/blog/2013/05/08/saner-rails-logging/">code for Utlity.logException</a>).
</li>
<li>fulfill_order is moved outside of the transaction block. This allows the
   transaction to complete, and then the order_fulfillment takes place. If
   there&#8217;s an issue in fulfilling the order, that can be dealt with separately
   from the original charge. In other words, the customer can successfully pay
   for the order, and the store can deal with the failure to fulfill the order.
</li>
</ol>


</div>

</div>




<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">RSpec Capybara Feature (Integration) Tests of UI Errors</h2>
<div class="outline-text-2" id="text-6">

<p>It&#8217;s possibly more important and sometimes easier to do the verification at the
integration level in RSpec feature specs using <a href="https://github.com/jnicklas/capybara">Capybara</a> with <a href="http://phantomjs.org/">PhantomJs</a> and
<a href="https://github.com/jonleighton/poltergeist">Poltergeist</a>. The secret sauce is the same use of the same stubbing technique as
above to replace some key methods such that they throw an exception. This sort
of technique works amazingly well to ensure that application will do the right
then when an unexpected failure occurs, from the logging and emailing of the
error message to the browser display to then end user.
</p>
<p>
I tend to develop such a test in an iterative manner:
</p><ol>
<li>Make sure you&#8217;ve got tests on the &#8220;happy&#8221; case where the story goes as
   planned.
</li>
<li>Then introduce test cases where have bits of code like this that will raise
   an error at an opportune time.
</li>
</ol>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="no">Order</span><span class="o">.</span><span class="n">any_instance</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:fulfill_order</span><span class="p">)</span> <span class="p">{</span> <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;test error&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<ol>
<li>Allow the test cases to fail, and put in screen shots (in Capybara with
   phantomjs, that looks like this:
</li>
</ol>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="n">render_page</span> <span class="s2">&quot;a-descriptive-name&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>
   Setup this method <code>render_page</code> in a spec helper file like this:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="k">def</span> <span class="nf">render_page</span> <span class="nb">name</span>
</span><span class='line'>     <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">integration_test_render_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">.png&quot;</span>
</span><span class='line'>     <span class="n">page</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</p><ol>
<li>Put in some assertions that the page shows the correct error and the records
   in the database have the right values.
</li>
<li>You can even 
</li>
</ol>


<p>  
Here&#8217;s an example that tests a failure of the Stripe payment API, including
verification that an email was sent signifying an error:
</p>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># using gem vcr to record http communication for faster performance</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:order</span> <span class="p">}</span> <span class="c1"># lots of setup in factory girl for non-purchased order</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">scenario</span> <span class="s2">&quot;Purchase cart, Strip payment error&quot;</span><span class="p">,</span> <span class="ss">:vcr</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Setup the stub -- the secret sauce to this test</span>
</span><span class='line'>    <span class="n">error_content</span> <span class="o">=</span> <span class="s2">&quot;Testing error handling exception message&quot;</span>
</span><span class='line'>    <span class="no">PaymentGateway</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:charge</span><span class="p">)</span> <span class="p">{</span> <span class="k">raise</span> <span class="ss">Stripe</span><span class="p">:</span><span class="ss">:InvalidRequestError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">error_content</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">place_order</span>
</span><span class='line'>    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span> <span class="n">error_content</span>
</span><span class='line'>    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span> <span class="s2">&quot;Error purchasing&quot;</span>
</span><span class='line'>    <span class="n">order</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'>    <span class="n">order</span><span class="o">.</span><span class="n">purchased</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">place_order</span>
</span><span class='line'>   <span class="n">login_as</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="ss">:user</span><span class="p">)</span>
</span><span class='line'>   <span class="n">visit</span> <span class="n">shopping_cart_path</span>
</span><span class='line'>   <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;.total .price&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">in_dollars</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
</span><span class='line'>   <span class="n">page</span><span class="o">.</span><span class="n">render_page</span><span class="p">(</span><span class="s2">&quot;purchase-cart-1&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="n">click_link</span> <span class="s2">&quot;CHECKOUT&quot;</span>
</span><span class='line'>   <span class="n">fill_in_credit_card_info</span> <span class="c1"># utility test method to fill in credit card data</span>
</span><span class='line'>   <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;.total .price&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">in_dollars</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
</span><span class='line'>   <span class="n">render_page</span><span class="p">(</span><span class="s2">&quot;purchase-cart-with-payment-info-2&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="n">click_on</span> <span class="s2">&quot;PURCHASE&quot;</span>
</span><span class='line'>   <span class="n">wait_for_spinners</span> <span class="c1"># method to wait for the busy spinner to stop</span>
</span><span class='line'>   <span class="n">render_page</span><span class="p">(</span><span class="s2">&quot;purchase-cart-after-click-purchase-3&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="n">validate_error_emailed</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="c1"># example of how you verify that an error was emailed</span>
</span><span class='line'> <span class="k">def</span> <span class="nf">validate_error_emailed</span>
</span><span class='line'>   <span class="n">email</span> <span class="o">=</span> <span class="ss">ActionMailer</span><span class="p">:</span><span class="ss">:Base</span><span class="o">.</span><span class="n">deliveries</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>   <span class="n">email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
</span><span class='line'>   <span class="n">email</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>   <span class="n">email</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s1">&#39;whoever@gets-error.com&#39;</span><span class="p">)</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


</div>

</div>




<div id="outline-container-7" class="outline-2">
<h2 id="sec-7">Conclusion</h2>
<div class="outline-text-2" id="text-7">

<p>If you aren&#8217;t simulating how your application responds to errors, then you&#8217;ll
eventually find out, and the result might not be as good as you&#8217;d prefer. You
can simulate errors with the very simple and quick technique of a well placed
=raise &#8220;some error&#8221;=, and then testing in a UI. Or you might prefer the
robustness of unit or feature tests using stubbing. Either way, the key message
is to check how your application handles errors, before your customers do.
</p></div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/08/strategies-for-rails-logging-and-error-handling/">Strategies for Rails Logging and Error Handling</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-08T17:41:00-10:00" pubdate data-updated="true">May 8<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/08/strategies-for-rails-logging-and-error-handling/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
TLDR: Clean logging and error handling is a critical aspect of a RoR app.
What&#8217;s a good strategy? Why does this matter?
</p>


<p>
A Rails app can have awesome unit and functional tests, and then in production,
something goes wrong and the right error handling does not happen, making
a bad situation worse. By this, I mean, it&#8217;s bad enough that something went
wrong in production. It&#8217;s even worse if:
</p>


<ol>
<li>You don&#8217;t have clear log messages that identify exactly what went wrong.
</li>
<li>You didn&#8217;t get automatically notified via email that something went wrong.
   Instead, the customer told the customer service rep that there&#8217;s an issue.
   Ideally, when an error happens, the responsible developers should be
   notified.
</li>
</ol>




<p>
Here&#8217;s some tips on logging setup and error handling, including a utility
method to log the stack trace and send an email.
</p>




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Log Setup</a>
<ul>
<li><a href="#sec-1-1">1.1 Notification of any Exceptions via Email with Gem exception_notification</a></li>
<li><a href="#sec-1-2">1.2 Log the Browser Details with Gem &#8216;browser_details&#8217;</a></li>
<li><a href="#sec-1-3">1.3 Control Rails Log Verbosity with Gem lograge</a></li>
<li><a href="#sec-1-4">1.4 Utility Method to Log Exceptions</a></li>
</ul>
</li>
<li><a href="#sec-2">2 Strategy: Error Handling and Logging</a></li>
</ul>
</div>
</div>




<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Log Setup</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">Notification of any Exceptions via Email with Gem exception_notification</h3>
<div class="outline-text-3" id="text-1-1">

<p>Check out the gem <a href="http://smartinez87.github.io/exception_notification/">exception_notification</a>. It works great. One things the docs
don&#8217;t point out is that it works great with <a href="http://mailcatcher.me/">MailCatcher</a>. This allows you to
&#8220;test&#8221; that your exception notification emails are being sent as expected
without using a real mail account. Thus, <i>do</i> enable exception logging in
development mode, contrary to the basic setup. Here&#8217;s a config example at this
post on <a href="http://www.mikeperham.com/2012/12/09/12-gems-of-christmas-4-mailcatcher-and-mail_view/">MailCatcher and mail_view</a>.
</p>
</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">Log the Browser Details with Gem &#8216;browser_details&#8217;</h3>
<div class="outline-text-3" id="text-1-2">

<p>The gem <a href="https://github.com/gshutler/browser_details">browser_details</a> will tell you what type of browser was used, which
can be very important when errors occur. I cracked up when I read this from the
gem info page: 
</p><blockquote>

<p>Have you ever had the conversation:
</p>
<p>
Your site doesn&#8217;t work.
What browser are you using and do you have Javascript enabled?
</p>
<p>
What&#8217;s a browser?
</p>
</blockquote>



</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3">Control Rails Log Verbosity with Gem lograge</h3>
<div class="outline-text-3" id="text-1-3">

<p>Sometimes too much of a good thing (log info) is a bad thing, and that&#8217;s true
with Rails default logging. Check out the gem &#8217;<a href="https://github.com/roidrage/lograge">lograge</a>&#8217;. The big difference is
that a single request will take a single line. To quote the README, instead of
logs like this:
</p>


<pre class="example">Started GET "/" for 127.0.0.1 at 2012-03-10 14:28:14 +0100
Processing by HomeController#index as HTML
  Rendered text template within layouts/application (0.0ms)
  Rendered layouts/_assets.html.erb (2.0ms)
  Rendered layouts/_top.html.erb (2.6ms)
  Rendered layouts/_about.html.erb (0.3ms)
  Rendered layouts/_google_analytics.html.erb (0.4ms)
Completed 200 OK in 79ms (Views: 78.8ms | ActiveRecord: 0.0ms)
</pre>


<p>
After installing lograge, you&#8217;ll have one line for the request:
</p>


<pre class="example">method=GET path=/jobs/833552.json format=json controller=jobs action=show status=200 duration=58.33 view=40.43 db=15.26
</pre>


<p>
The one issue with <code>lograge</code> is that the default configuration does not log
request parameters, which can be useful for debugging. This blog post, <a href="http://ionrails.com/2013/03/26/how-to-add-the-request-parameters-along-with-full-url-request-in-lograge-outputted-files/">How to add request parameters to lograge logs</a>, addresses that shortcoming.
</p>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4">Utility Method to Log Exceptions</h3>
<div class="outline-text-3" id="text-1-4">

<p>This sample method <code>Utility.log_exception</code> takes care of logging an exception along with sending out an
email notification.
</p>
<p>
Example of calling <code>Utility.log_exception</code>:
</p>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">my_method_with_error</span> <span class="n">foobar</span>
</span><span class='line'>  <span class="n">do_something_that_raises</span> <span class="n">foobar</span>
</span><span class='line'><span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span> <span class="c1"># catches StandardError (don&#39;t use rescue Esception =&gt; e)</span>
</span><span class='line'>  <span class="no">Utility</span><span class="o">.</span><span class="n">log_exception</span> <span class="n">e</span><span class="p">,</span> <span class="ss">info</span><span class="p">:</span> <span class="s2">&quot;called do_something_that_raises wihh </span><span class="si">#{</span><span class="n">foobar</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Definition of <code>Utility.log_exception</code>:
</p>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Utility</span>
</span><span class='line'>  <span class="c1"># Logs and emails exception</span>
</span><span class='line'>  <span class="c1"># Optional args:</span>
</span><span class='line'>  <span class="c1"># request: request Used for the ExceptionNotifier</span>
</span><span class='line'>  <span class="c1"># info: &quot;A descriptive messsage&quot;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">log_exception</span> <span class="n">e</span><span class="p">,</span> <span class="n">args</span>
</span><span class='line'>    <span class="n">extra_info</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:info</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="n">extra_info</span> <span class="k">if</span> <span class="n">extra_info</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
</span><span class='line'>    <span class="n">st</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span> <span class="n">st</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">extra_info</span> <span class="o">||=</span> <span class="s2">&quot;&lt;NO DETAILS&gt;&quot;</span>
</span><span class='line'>    <span class="n">request</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:request</span><span class="o">]</span>
</span><span class='line'>    <span class="n">env</span> <span class="o">=</span> <span class="n">request</span> <span class="p">?</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span> <span class="p">:</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">env</span>
</span><span class='line'>      <span class="ss">ExceptionNotifier</span><span class="p">:</span><span class="ss">:Notifier</span><span class="o">.</span><span class="n">exception_notification</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;Exception: </span><span class="si">#{</span><span class="n">extra_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="ss">ExceptionNotifier</span><span class="p">:</span><span class="ss">:Notifier</span><span class="o">.</span><span class="n">background_exception_notification</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;Exception: </span><span class="si">#{</span><span class="n">extra_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


</div>
</div>

</div>




<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">Strategy: Error Handling and Logging</h2>
<div class="outline-text-2" id="text-2">

<ol>
<li>Avoid rescuing/catching if you can&#8217;t do anything with the exception. For
   example, in a model method, you might be calling that from a controller, but
   you also might be calling that from some scheduled job. Thus, it&#8217;s hard to
   say what the right action should be. A special case is calling <code>raise</code> without
   arguments: sometimes it is reasonable to catch all exceptions, logging the
   exception, and then re-raising it like it was never caught.
</li>
<li>If you catch an exception, consider if you should re-throw the exception
   because code at a different level will be able to handle the exception more
   properly.
</li>
<li>Consider how the code is being invoked, such as from a call to generate
   HTML or an ajax request, or maybe a batch job. All of these cases have very
   different needs for how the error should be handled.
</li>
<li>Be sure you understand the order of your rescue clauses matter. This article
   <a href="http://blog.rubybestpractices.com/posts/rklemme/003-The_Universe_between_begin_and_end.html">The Universe between <code>begin</code> and <code>end</code></a> provides a good explanation.
   Basically put the most specific exception types first and something like
   <code>rescue =&gt; e</code> last.
</li>
<li>Ruby does not support the concept of a &#8220;cause&#8221; with an exception. Thus, if
   you catch an exception and are going to rethrow a different exception, then
   it&#8217;s important to log the stack of the original exception, or else that
   information will be lost.
</li>
<li>Test the logging of the exception in both development and production mode.
   You want to ensure that any exception prints clearly regardless of Rails
   environment.
</li>
<li>A good way to test error handling is to temporarily put in <code>raise    ArgumentError</code> (or whatever other error), and see how the exception is
   handled, both by the logger and the UI.
</li>
<li>The worst scenario is catching an exception and failing to log any messages.
   This can make troubleshooting a problem very tricky.
</li>
</ol>



</div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/07/buying-apple-products-with-amex/">Buy Apple Products With American Express</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-07T21:53:00-10:00" pubdate data-updated="true">May 7<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/07/buying-apple-products-with-amex/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Here&#8217;s a few tips on buying Apple gear and credit card extended warranties. The
bottom line is:
</p>


<ul>
<li>Consider buying <b>AppleCare</b> with <b>American Express</b> to get an extended warranty that
  extends 12 months past AppleCare&#8217;s 3 years. That&#8217;s 4 years total! Visa and
  MasterCard <b>do not</b> extend AppleCare&#8217;s 3 years.
</li>
<li>If you don&#8217;t need AppleCare, then try to buy with American Express, as you know you&#8217;ll
  still get an extra 12 months. Visa or MasterCard may or may not offer a
  warranty extension depending on your card.
</li>
<li>Avoid buying AppleCare with a Visa or MasterCard if the card already has a
  warranty extension. You would get 24 months of basic coverage (one year
  original plus one year card). For the price of AppleCare, you get only an
  extra 12 months, although some will want the telephone question coverage of
  AppleCare.
</li>
</ul>




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Buying Tips</a></li>
<li><a href="#sec-2">2 AppleCare</a></li>
<li><a href="#sec-3">3 American Express, not Mastercard, if you buy AppleCare</a></li>
<li><a href="#sec-4">4 Details (the fine print)</a>
<ul>
<li><a href="#sec-4-1">4.1 American Express</a></li>
<li><a href="#sec-4-2">4.2 MasterCard</a></li>
<li><a href="#sec-4-3">4.3 Visa</a></li>
</ul>
</li>
</ul>
</div>
</div>




<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Buying Tips</h2>
<div class="outline-text-2" id="text-1">

<p>Buy products when they just come out, or wait until the next version comes out.
It seems like Apple products don&#8217;t really go on sale, so you might as well get
the newest stuff, or wait if you can. A good place to check is <a href="http://buyersguide.macrumors.com/">MacRumors Buyers Guide</a>. That being said, if you need something, then you need it, so just buy
it. If you&#8217;re not sure, then you can probably wait.
</p>
</div>

</div>




<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">AppleCare</h2>
<div class="outline-text-2" id="text-2">

<p>In general, you&#8217;d probably be off without extended warranties unless there&#8217;s
something special about your situation that suggest one is worth it. Plus, if
you buy with the right credit card, you&#8217;ll get one year extension, giving you a
full years without paying a cent. Here&#8217;s an article on <a href="http://lifehacker.com/5697141/skip-the-extended-warranty-use-a-good-credit-card-instead">LifeHacker: Skip the Extended Warranty; Use a Good Credit Card Instead</a>. I live on the beach, so
everything tends to rust, so I tend to buy extended warranties for this reason.
</p>
</div>

</div>




<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">American Express, not Mastercard, if you buy AppleCare</h2>
<div class="outline-text-2" id="text-3">

<p>Both American Express and Mastercard offer warranty extensions of up to one year for using
their cards. However, there&#8217;s a huge difference in their policies. American Express
specifically states that they extend past supplemental warranty extensions like
AppleCare. MasterCard explicitly says they do not. Visa is ambiguous. I quoted
the details below. American Express will provide up to one year additional for warranties
up to 5 years. MasterCard only goes to one year. Visa goes to 3 years.
</p>

</div>

</div>




<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Details (the fine print)</h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1">American Express</h3>
<div class="outline-text-3" id="text-4-1">

<p>I&#8217;ve got the Costco True Earnings card. The details of the plan are
here:<a href="http://www.americanexpress.com/us/content/pdf/card-benefits/TrueEarningsCardfromCostcoandAmericanExpress/EW-DOC-CCSG.pdf">EXTENDED WARRANTY DESCRIPTION OF COVERAGE</a>. Kudos to the American Express for website
for making it easy to find the information (unlike MasterCard).
</p>
<p>
Just to be sure, I found the spot which ensures that I get one year past when
AppleCare ends:
</p>
<blockquote>

<p>Where a Loss has occurred during this Plan&#8217;s extended warranty time period of up
to one (1) additional year, We will provide a benefit equal to the coverage of
the original manufacturer&#8217;s warranty on warranties of up to five (5) years. We
will pay up to the actual amount charged to Your Account for the product for
which a Loss is claimed, but not to exceed $10,000. If the product also is
covered by a purchased service contract, this Plans extended warranty time
period begins at the end of the service contract and extends the original
manufacturers warranty for a period of time equal to that warranty, up to one
(1) additional year. If the combined coverage of the original manufacturers
warranty and the purchased service contract exceed five (5) years, the product
purchased is not eligible under this Plan and no coverage applies.
</p>
</blockquote>



</div>

</div>

<div id="outline-container-4-2" class="outline-3">
<h3 id="sec-4-2">MasterCard</h3>
<div class="outline-text-3" id="text-4-2">

<p>Your bank&#8217;s website will not have any information about any extended warranty.
You have to go to MasterCard&#8217;s website: <a href="http://www.mastercard.com/us/personal/en/cardholderservices/guidetobenefits/pdf/489247_extended_warranty_v2.pdf">Guide to Benefits EXTENDED WARRANTY COVERAGE</a>. MasterCard is the stingiest. If the product has more than a one year
warranty, then MasterCard does not help.
</p>
<blockquote>

<p>&gt; Extended Warranty doubles the original warranty time period and duplicates the coverage of
the original manufacturers (or U.S. store brand) warranty up to a maximum of twelve (12)
months on most items you purchase. For products with multiple warranty components,
each warranty time period will be duplicated up to a maximum of twelve (12) months.
Should you fail to properly register the original warranty as required by manufacturer,
Extended Warranty will only double the actual warranty time period that you received from
the manufacturer. An example of a product with multiple warranty components includes an
appliance with original manufacturers (or U.S. store brand) warranties that differ for parts,
labor, compressor, etc.
</p>
<p>
&gt; If you purchase a service contract or an optional extended warranty of twelve (12) months
or less on your item, Extended Warranty will cover up to an additional twelve (12) months
after both the original manufacturers (or U.S. store brand) warranty and the purchased
service contract or extended warranty coverage period end. If your service contract or
extended warranty exceeds twelve (12) months, this coverage does not apply.
</p>
<p>
&gt; If you do not have an additional service contract or an optional extended warranty, this
Extended Warranty benefit commences the day after your original manufacturers (or U.S.
store brand) warranty expires.
</p>
<p>
&gt; If either the original manufacturers (or U.S. store brand) warranty or the service contract
covers more than twelve (12) months, Extended Warranty benefits will not apply.
</p>
</blockquote>


</div>

</div>

<div id="outline-container-4-3" class="outline-3">
<h3 id="sec-4-3">Visa</h3>
<div class="outline-text-3" id="text-4-3">

<p>Here&#8217;s the Visa benefits for one type of card: <a href="http://usa.visa.com/business/why-pay-with-visa/security-benefits/bft-purchase-security.html">VISA PURCHASE PROTECTION</a>. Note,
each Visa card may be different. Visa is a lot better than MasterCard in that
if your product has more than a 1 year warranty, Visa still gives you an extra
year.
</p>
<blockquote>

<p>Extended Protection Yes, as long as you purchased the item entirely with your
eligible U.S.- issued Visa Business card and the eligible item has a valid
original manufacturers written U.S. repair warranty or assembler warranty of
three (3) years or less.
</p>
</blockquote>





<ul>
<li>Here&#8217;s a good article with more details on why you should American Express for all
  extended warranties: <a href="http://www.cardhub.com/edu/credit-card-extended-warranty-study/">2012 Credit Card Extended Warranty Study</a>
</li>
<li>Another comparison, from the NYT: <a href="http://bucks.blogs.nytimes.com/2012/08/01/credit-cards-with-the-best-extended-warranties/">Credit Cards With the Best Extended Warranties</a>
</li>
<li>LifeHacker: <a href="http://lifehacker.com/5871487/are-extended-warranties-worth-it">Are Extended Warranties Worth It?</a>
</li>
</ul>

</div>
</div>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/27/octopress-setup-with-github-and-org-mode/">Octopress Setup With Github, Org Mode, and LiveReload</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-27T22:46:00-10:00" pubdate data-updated="true">Apr 27<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/04/27/octopress-setup-with-github-and-org-mode/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
WordPress seemed like a good blogging platform, but it just didn&#8217;t feel right. I
spend all my day editing text files using vim key-bindings, and I love <a href="http://orgmode.org/">Org Mode</a> for all non-coding writing. If you don&#8217;t know Org Mode, it&#8217;s like having
Markdown mode on steroids. You can have a numbered list in Markdown, but
org-mode lets you re-order the list, and that&#8217;s just the beginning. Editing blog
documents in the WordPress editor felt almost as bad as being told to use MS
Word. I found that ergonomics of Org Mode, including all the goodness of recent
versions of <a href="http://www.gnu.org/software/emacs/">Emacs</a>, including <a href="http://emacswiki.org/emacs/Evil">Evil</a> (Vim emulation), just made organization of
creative thoughts so much more enjoyable.
</p>


<p>
So I bit the bullet one weekend, and dove into <a href="http://octopress.org/">Octopress</a>. You&#8217;re looking at the
results of this endeavor, including my first Octopress article, and the latest
tips on recreating this sort of blog using Octopress with Org Mode authoring,
using LiveReload, and deployed at no charge on github.com. 
</p>


<p>
If you used to writing real web applications, rather than know the intricacies
of a giant monolithic blogging platform, then the <a href="http://octopress.org/docs/theme/template/">customization of Octopress</a>
seems so much more straightforward. This is so much more like the Unix
philosophy that so many of us love, which is small and modular, rather than
monolithic.
</p>


<p>
I like <a href="https://github.com/robdodson/robdodson.github.com/blob/source/source/_posts/2012-04-30-custom-domain-with-octopress-and-github-pages.markdown">Rob Dodson&#8217;s summary</a> (noting Org Mode plus Emacs):
</p>


<blockquote><p><a href="http://octopress.org/">Octopress</a> is a blogging framework written by <a href="http://brandonmathis.com/">Brandon Mathis</a>
(<a href="https://twitter.com/#!/imathis">@imathis</a>) which sits on top of <a href="https://github.com/mojombo/jekyll">Jekyll</a>. Jekyll is
a static site generator, meaning there&#8217;s no database associated with your blog. Instead of writing everything in a
WSYWIG linked to MySQL (like Wordpress or Blogger) you produce text files using Markdown which are then converted to
static HTML. There are 3 huge benefits to this approach. First, writing in
Markdown [<em>org-mode</em> for Justin] is awesome. Once you learn the
syntax it&#8217;s incredibly fast and you don&#8217;t have to spend time playing with a tiny little editor window just to
<s>add</s> <em>some</em> <strong>style</strong> to your posts. Second, writing in your favorite text editor is also awesome. I produce
everything in <a href="http://www.sublimetext.com/2">Sublime Text 2</a> [<em>Emacs</em> for Justin] and every day I discover new tricks to make the process
better. If you&#8217;ve ever had to write a blog post using one of those horrible little TinyMCE editors you will appreciate
this feature. And lastly, static HTML is <em>fast</em>.</p></blockquote>

<p>
I found it totally neat that I could embed markdown inside the org-mode
document. See below for how this is done.
</p>


<p>
This article should be useful for:
</p>


<ol>
<li>Any interest in using org-mode to publish to Octopress including some
     reasons I use Org Mode (with Emacs).
</li>
<li>Some explanation of what Octopress and git are doing.
</li>
<li>How to use LiveReload with Octopress and Org Mode.
</li>
<li>Anybody curious about how using free github pages works to host Octopress.
</li>
</ol>




<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Basic setup</a></li>
<li><a href="#sec-2">2 Some Perspectives on how Octopress Works</a>
<ul>
<li><a href="#sec-2-1">2.1 Posts</a></li>
<li><a href="#sec-2-2">2.2 Pages</a></li>
</ul>
</li>
<li><a href="#sec-3">3 POW</a></li>
<li><a href="#sec-4">4 LiveReload</a></li>
<li><a href="#sec-5">5 Org-Mode</a>
<ul>
<li><a href="#sec-5-1">5.1 Why org-mode for blog publishing?</a></li>
<li><a href="#sec-5-2">5.2 Org-mode Integration</a></li>
</ul>
</li>
<li><a href="#sec-6">6 Useful Scripts</a></li>
<li><a href="#sec-7">7 Deploying to Github: Directory Structure of Octopress and the master and source Git Branches</a></li>
<li><a href="#sec-8">8 Useful Links</a></li>
<li><a href="#sec-9">9 Parting words&hellip;</a></li>
</ul>
</div>
</div>




<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Basic setup</h2>
<div class="outline-text-2" id="text-1">

<ol>
<li><a href="#http-robdodson.me-blog-2012-04-30-custom-domain-with-octopress-and-github-pages">Rob Dodson on Octopress</a>: Start off with these instructions from this posting
   on April 30th, 2012. There are a few differences worth noting:
<ol>
<li>You may wish to change the .rvmrc to a .ruby-version file
</li>
<li>Github recommends your deployment repository be named <code>yourname.github.io</code>,
      not <code>yourname.github.com</code>.
</li>
<li>After you run <code>rake setup_github_pages</code> and before running <code>rake       generate</code>, you should run <code>rake install</code>. If you forget, there&#8217;s a clear
      message indicating this omission.
</li>
</ol>

</li>
<li>Customize <code>octopress/_config.yml</code>. The yaml file contains descriptions.
</li>
<li>Update the DNS to use your custom domain if you wish: <a href="https://help.github.com/articles/setting-up-a-custom-domain-with-pages">Github directions on setting up a custom domain</a>
</li>
<li>At this point, you can create a post:
</li>
</ol>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  rake new_post<span class="o">[</span><span class="s2">&quot;my post name&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p> 
  Create a page:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  rake new_page<span class="o">[</span><span class="s2">&quot;my page name&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


  Generate and deploy:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  rake gen_deploy
</span></code></pre></td></tr></table></div></figure>

</p>
<p> 
  Watch the site and regenerate when it changes:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  rake watch
</span></code></pre></td></tr></table></div></figure>

</p>
<p>  
  Preview the site in a web browser:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  rake preview
</span></code></pre></td></tr></table></div></figure>

</p>
<p>  
  See all the available rake options:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  rake -T
</span></code></pre></td></tr></table></div></figure>


  Save changes to source branch:

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  git add .
</span><span class='line'>  git commit -m <span class="s2">&quot;save changes to source&quot;</span>
</span><span class='line'>  git push origin <span class="nb">source</span>
</span></code></pre></td></tr></table></div></figure>


</p></div>

</div>




<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">Some Perspectives on how Octopress Works</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">Posts</h3>
<div class="outline-text-3" id="text-2-1">

<p><b>Posts</b> are created using the rake task <code>rake new_post["Post Title"]</code>. The key things about a post are:
</p><ol>
<li>File is located in =source/_posts.
</li>
<li>File has a header containing the meta-data for the post. The post URL and
   date are determined by the by the <code>title</code> and <code>date</code> fields. If you want to
   change the date of your post, then you change the meta-data. Changing the
   file name is useful only for file navigation. Here&#8217;s a <a href="https://gist.github.com/justin808/5550381">gist for a rake task to update the file names to match the metadata</a>.
</li>
</ol>


</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">Pages</h3>
<div class="outline-text-3" id="text-2-2">

<p><b>Pages</b> are created using the rake task <code>rake new_page["Page Title"]</code>. The key
things about a page are:
</p><ol>
<li>Files are located in =source/page-title
</li>
<li>File has a header containing the meta-data for the post. The post URL and
</li>
</ol>





</div>
</div>

</div>




<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">POW</h2>
<div class="outline-text-2" id="text-3">

<p>POW allows you to point your browser to <a href="http://octopress.dev">http://octopress.dev</a> to see your local,
unpublished Octopress website. It&#8217;s very convenient to not have to remember to
run a local server, and it works great with LiveReload. Scroll to the bottom of
this link for details on <a href="http://octopress.org/docs/blogging/">POW</a>. The alternative to running POW is to run <code>rake preview</code> and then point your browser at <code>http://0.0.0.0:4000</code> (or whatever port
you configured).
</p>
</div>

</div>




<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">LiveReload</h2>
<div class="outline-text-2" id="text-4">

<p>LiveReload is a <a href="https://chrome.google.com/webstore/detail/livereload/jnihajbhpnppcggbcgedagnkighmdlei?hl=en">Chrome browser extension</a> that will automatically refresh
the browser after you publish your file. This works with or without POW.
</p><ul>
<li><a href="http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-">Install the browser extension</a> for your type of browser.
</li>
<li>Add these two entries to your <code>Gemfile</code>, in the :development group:
</li>
</ul>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="n">gem</span> <span class="s1">&#39;guard&#39;</span>
</span><span class='line'>   <span class="n">gem</span> <span class="s1">&#39;guard-livereload&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create a file called <code>Guardfile</code> containing something like:
</li>
</ul>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="n">guard</span> <span class="s1">&#39;livereload&#39;</span> <span class="k">do</span>
</span><span class='line'>       <span class="n">watch</span><span class="p">(</span><span class="sr">%r{public/generated}</span><span class="p">)</span>
</span><span class='line'>       <span class="n">watch</span><span class="p">(</span><span class="sr">%r{public/.+\.(css|js|html)}</span><span class="p">)</span>
</span><span class='line'>     <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Start 2 shell tabs running these commands: <code>rake generate &amp;&amp; rake watch</code>
   and <code>guard</code> 
</li>
</ul>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>     &gt; rake generate <span class="o">&amp;&amp;</span> rake watch
</span></code></pre></td></tr></table></div></figure>

<p>
   This screen shot shows <code>watch</code> updating the deployment files.
   <img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/rake-generate-watch.png">
   start guard LiveReload

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>     &gt; guard
</span></code></pre></td></tr></table></div></figure>

   This screen grab shows guard detecting the browser and telling the
   browser to update.
   <img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/guard-console.png">
</p>
<p>
It&#8217;s neat to get LiveReload working with Octopress. However, the generation can
finish after your page does a reload, so you won&#8217;t see your latest changes. I&#8217;ll
update this blog post when I figure out a solution to that one. Until then, you
may find it more convenient to manually refresh the blog page yourself.
</p>
<p>
It&#8217;s worth noting that if you&#8217;re running any other instance of guard-
LiveReload, then one of these two copies will win and one won&#8217;t work. If you
run a rails server this way, then this can bite you. It took me a bit of time
to figure out why guard wasn&#8217;t working.
</p>
</div>

</div>




<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">Org-Mode</h2>
<div class="outline-text-2" id="text-5">

<p>You can skip this section if you&#8217;re not interested in org-mode. However, it&#8217;s
super cool!
</p>
</div>

<div id="outline-container-5-1" class="outline-3">
<h3 id="sec-5-1">Why org-mode for blog publishing?</h3>
<div class="outline-text-3" id="text-5-1">

<p><a href="http://orgmode.org/">Org-mode</a> offers quite a bit more than plain markdown. It&#8217;s quite the <b>hacker&#8217;s delight</b> for note taking and authoring of blog articles. Down below I list a few
reasons why org-mode. Here&#8217;s a few org-mode features I love (Some are Emacs
ones):
</p><ol>
<li>All headers and list items can be reordered with minimal keystrokes (think
   super powerful outliner).
</li>
<li>Numbered lists.
</li>
<li>Editable tables in text editor, with movable columns, movable rows.
</li>
<li>Ergonomics of insertion of URLs and images.
</li>
<li>Includes the basics of markdown, such as source code blocks and much more.
</li>
</ol>


</div>

</div>

<div id="outline-container-5-2" class="outline-3">
<h3 id="sec-5-2">Org-mode Integration</h3>
<div class="outline-text-3" id="text-5-2">

<p>I found a plugin that automates the process of converting an org-mode document
(<code>.org</code> file) in <code>source/org_posts</code> into a <code>.markdown</code> document in
<code>source/_posts</code>. Once the markdown document is saved in _posts, the <code>rake watch</code> task picks up the change and deploys the file, and LiveReload can then
automatically update your web browser. <b>Neat!</b>
</p>
<p>
Here are the basic steps:
</p><ol>
<li>Follow the instructions here: <a href="http://blog.paphus.com/blog/2012/08/01/introducing-octopress-blogging-for-org-mode/">Introducing Octopress Blogging for Org-Mode</a>
</li>
<li>At the time of this article, April 27, there&#8217;s a bug with the latest
   org-mode. <a href="https://github.com/craftkiller/orgmode-octopress/issues/3">I posted a workaround.</a> By the time you read this, you probably
   won&#8217;t need that tip.
</li>
<li>You can embed Markdown (or other Octopress/Jekyll directives) by embedding
   inside of a <code>#+begin_html</code> and <code>#+end_html</code> block.
   <img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/quoting-markdown-in-org-mode.png">
</li>
<li><del>Images work fine.</del> Well, almost fine. The big gotcha is that the standard
   inclusion of images in org-mode results in broken paths at deployment. The
   workaround is to embed the <a href="http://octopress.org/docs/plugins/image-tag/">Octopress syntax for an image</a>, and to place the
   images under source/images. Note, you&#8217;ll want to be sure to use an absolute
   path, or else your article might look OK on the home page, but might now work
   in the postings directory. If I&#8217;m creating a document with many images, I&#8217;ll
   group the images for that document in a sub-directory of images named like
   the document. This is how it should look. The trick is to place the
   octopress <code>img</code> directive within a HTML begin/end block.

<p>
   <img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/org-mode-images.png">
</p></li>
<li>Links to other pages or posts require using something like this. The trick
   is that you have to specify <code>http:</code> and place the <code>html</code> file suffix type.
   Also note using one slash at the beginning for an absolute path.



<pre class="example">[[http:/about/some_details.html][Some Details]]  
</pre>

</li>
<li>Bold styling was a bit of mystery using the standard theme. I had to add
   this line to _typography.scss:
</li>
</ol>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>   <span class="nt">b</span> <span class="p">{</span> <span class="k">font-weight</span><span class="o">:</span> <span class="k">bold</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
</div>

</div>




<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">Useful Scripts</h2>
<div class="outline-text-2" id="text-6">

<ul>
<li>Just configure <code>OCTO_HOME</code>
</li>
<li>Emacs tip: Visit the created file by placing cursor over file name and then hit <code>Ctrl-x, f</code>. 
</li>
</ul>



<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">OCTO_HOME</span><span class="o">=</span>~/octopress
</span><span class='line'>ogen <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">cd</span> <span class="nv">$OCTO_HOME</span>; rake generate; <span class="nb">cd</span> -
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>osave <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">cd</span> <span class="nv">$OCTO_HOME</span>; git commit -am <span class="s2">&quot;Updates&quot;</span> <span class="o">&amp;&amp;</span> git push origin <span class="nb">source</span>; <span class="nb">cd</span> -
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>odeploy <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">cd</span> <span class="nv">$OCTO_HOME</span>; osave; rake gen_deploy; <span class="nb">cd</span> -
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># this one is for orgmode only</span>
</span><span class='line'>opost<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">cd</span> <span class="nv">$OCTO_HOME</span>
</span><span class='line'>  <span class="nv">output</span><span class="o">=</span><span class="k">$(</span>rake new_post<span class="o">[</span><span class="s2">&quot;${1}&quot;</span><span class="o">]</span><span class="k">)</span>
</span><span class='line'>  <span class="nv">new_file</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$output</span> | awk <span class="s1">&#39;{print $4}&#39;</span><span class="k">)</span>
</span><span class='line'>  <span class="nv">base</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$new_file</span><span class="k">)</span>
</span><span class='line'>  <span class="nv">new_location</span><span class="o">=</span><span class="nv">$OCTO_HOME</span>/source/org_posts/
</span><span class='line'>  mv <span class="nv">$OCTO_HOME</span>/<span class="nv">$new_file</span> <span class="nv">$new_location</span>
</span><span class='line'>  <span class="nb">echo </span>created <span class="nv">$new_location</span>/<span class="nv">$base</span>
</span><span class='line'>  <span class="nb">cd</span> -
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>opage<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">cd</span> <span class="nv">$OCTO_HOME</span>
</span><span class='line'>  rake new_page<span class="o">[</span><span class="s2">&quot;${1}&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">cd</span> -
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


</div>

</div>




<div id="outline-container-7" class="outline-2">
<h2 id="sec-7">Deploying to Github: Directory Structure of Octopress and the master and source Git Branches</h2>
<div class="outline-text-2" id="text-7">

<p>Github offers free hosting of both the blog deployment and source. You&#8217;re
looking at the deployment right now. You can find the source here at
<a href="https://github.com/justin808/justin808.github.io">my git repo justin808.github.io</a>. I doubt you could beat the price, performance, and
convenience. You can look inside of this repo, clone it, etc. and you have
everything that it took to make this blog.
</p>
<p>
I originally was quite confused by the concept of using two separate git
branches to make up what gets deployed on the live website versus the git
repository of my articles. Plus, there&#8217;s the issue of Octopress git repository
that you clone when starting out. Eventually, I figured out that the two branches
simply contain different files, with one containing the original Octopress
files. Here&#8217;s a few screen grabs that might clarify the situation for you.
</p>
<p>
Don&#8217;t forget that you never push to the master branch, but rather the <code>rake deploy</code> task does it for you. Instead, you run <code>git push origin source</code> to push
the content of your blog to github.
</p>
<p>
The <code>octopress/public</code> directory corresponds to what you&#8217;ll find on the github
site for your deployment (master branch).
</p>
<p>
<img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/public-dir-corresponds-master-branch.png">
</p>
<p>
The octopress/.gitignore file contains entries like <code>public</code>, which essentially
keeps the <code>rake generate</code> files out of the source branch.
</p>
<p>
Here&#8217;s the github master branch right after creation. Note the correspondence
with <code>public</code>. This is what gets deployed as your blog.
<img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/github-master-branch.png">
</p>
<p>
Here&#8217;s the github source branch. This contains the octopress environment, as
well as your customizations and blog posts.
<img src="/images/2013-04-27-octopress-setup-with-github-and-org-mode/github-source-branch.png">

</p></div>

</div>




<div id="outline-container-8" class="outline-2">
<h2 id="sec-8">Useful Links</h2>
<div class="outline-text-2" id="text-8">

<ol>
<li><a href="http://webdesign.tutsplus.com/tutorials/applications/getting-started-with-octopress/">Getting Started with Octopress</a>: Nice overall tutorial. Very current!
   March 2013.
</li>
<li><a href="http://robdodson.me/blog/2012/04/30/custom-domain-with-octopress-and-github-pages">Rob Dodson on Octopress</a>: Most of the instructions I show below are from this
   posting on April 30th, 2012.
</li>
<li><a href="http://joelmccracken.github.io/entries/octopress-is-pretty-sweet/">Joel McCracken on Octopress</a>: Use Jekyll? You Really Should Be Using Octopress 
</li>
<li><a href="https://help.github.com/articles/setting-up-a-custom-domain-with-pages">Github directions on setting up a custom domain</a> 
</li>
<li><a href="http://code.dblock.org/octopress-setting-up-a-blog-and-contributing-to-an-existing-one">dblock.org Article on Octopress</a>: A good explanation from Jan 17, 2012,
   especially on the difference of the source and master branches.
</li>
<li><a href="http://blog.paphus.com/blog/2012/08/01/introducing-octopress-blogging-for-org-mode/">Introducing Octopress Blogging for Org-Mode</a>: For org-mode. See below.
</li>
<li><a href="http://hiltmon.com/blog/2013/04/17/18-months-of-octopress/">18 Months of Octopress</a>: Nice article on why Octopress was worth the switch.
</li>
<li><a href="http://odino.org/bash-aliases-for-octopress/">Shell Aliases for Octopress</a>: Save time with these shortcuts
</li>
</ol>



</div>

</div>




<div id="outline-container-9" class="outline-2">
<h2 id="sec-9">Parting words&hellip;</h2>
<div class="outline-text-2" id="text-9">

<p>Thanks in advance for any suggestions on this article. I hope you find it
helpful. Check me out on Twitter: <a href="http://twitter.com/railsonmaui">@RailsOnMaui</a>.
</p></div>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>I&#8217;m Justin Gordon. I love doing full stack development, surfing, and
  racing SUPs, all in Maui. You can find me on gmail
  as <code>justin.gordon</code>. I&#8217;m also on <a href='http://www.linkedin.com/pub/justin-gordon/1/a41/286'>Linked In</a>.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/11/testing-error-conditions-in-payment-processing/">Testing Error Handling of Payment Processing: Unit and Integration</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/08/strategies-for-rails-logging-and-error-handling/">Strategies for Rails Logging and Error Handling</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/07/buying-apple-products-with-amex/">Buy Apple Products with American Express</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/27/octopress-setup-with-github-and-org-mode/">Octopress Setup with Github, Org Mode, and LiveReload</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/justin808">@justin808</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'justin808',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/102850786590145072082?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>On Twitter:</h1>
  <div>
    <p><br /><a href="http://twitter.com/railsonmaui" target="_blank">My Tweets, on Twitter.</a></p>
    <a href="http://twitter.com/railsonmaui" class="twitter-follow-button" data-show-count="">Follow @railsonmaui</a>
  </div>
</section>


  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Justin Gordon -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'railsonmaui';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


Included file 'twitter_sharing.html' not found in _includes directory



</body>
</html>
