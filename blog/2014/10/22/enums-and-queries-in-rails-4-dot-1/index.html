
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Enums and Queries in Rails 4.1, and Understanding Ruby - Rails on Maui</title>
  <meta name="author" content="Justin Gordon">

  
  <meta name="description" content="Understanding Ruby and how enums work in Rails 4.1.">
  <meta name="keywords" content="Ruby on Rails, Enums, Ruby">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  <link rel="canonical" href="https://hackhands.com/ruby-on-enums-queries-and-rails-4-1/">
  <link href="/railsonmaui-favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/railsonmaui" rel="alternate" title="Rails on Maui" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/rubymine.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40522944-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Rails on Maui</a></h1>
  
    <h2>Programming in Paradise</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="http://feeds.feedburner.com/railsonmaui" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="http://feedburner.google.com/fb/a/mailverify?uri=RailsOnMaui&amp;loc=en_US" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.railsonmaui.com/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="/blog/categories.html">Categories</a></li>
  <li><a href="/tips/">Tips</a></li>
  <li><a href="/meta/">Meta</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="http://forum.railsonmaui.com">Forum</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Enums and Queries in Rails 4.1, and Understanding Ruby</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-22T19:23:02-10:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>7:23 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>
Sometimes when you get puzzled by what Rails is doing, you really just need to
understand what Ruby is doing.
</p>

<p>
For example, given this simple code to get an attribute value:
</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># return value of some_attribute and foobar</span>
</span><span class='line'><span class="k">def</span> <span class="nf">some_attribute_foobar</span>
</span><span class='line'>  <span class="s2">&quot;</span><span class="si">#{</span><span class="n">some_attribute</span><span class="si">}</span><span class="s2"> and foobar&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>
Beginners are often stumped by why this code does not set an attribute value:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># change the value of some_attribute to foobar</span>
</span><span class='line'><span class="k">def</span> <span class="nf">change_some_attribute</span>
</span><span class='line'>  <span class="c1"># why doesn&#39;t the next line set the some_attribute value to &quot;foobar&quot;?</span>
</span><span class='line'>  <span class="n">some_attribute</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'>  <span class="n">save!</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>
What&#8217;s going on?
</p>

<p>
In the first method, <code>some_attribute</code> is actually a method call which gets the
attribute value of the record. This works in Rails ActiveRecord due to the Ruby
feature of <a href="http://www.ruby-doc.org/core-2.1.3/BasicObject.html">method_missing</a> which allows some code to run when a method is called
that does not exist.
</p>

<p>
In the second method, a local variable called some_attribute is getting
assigned. There is no call to method_missing, as this is a variable assignment!
</p>

<p>
The correct code should have been:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># change the value of some_attribute to foobar</span>
</span><span class='line'><span class="k">def</span> <span class="nf">change_some_attribute</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">some_attribute</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'>  <span class="n">save!</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<!-- more -->

<p>
In this case, we&#8217;re calling the method <code>some_attribute=</code> on the model instance,
and we get the expected result of assigning an attribute value.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Enums</h2>
<div class="outline-text-2" id="text-1">
<p>
For those not familiar with enums:
</p>

<blockquote>
<p>
An enum type is a special data type that enables for a variable to be a set of
predefined constants. The variable must be equal to one of the values that have
been predefined for it.
</p>
</blockquote>

<p>
Enums, introduced in Rails 4.1, are a place a lot of Ruby magic happens! It&#8217;s
critical to understand Ruby well in order to understand how to use enums
effectively. Let&#8217;s suppose we have this simple example, copied over from the
<a href="http://edgeapi.rubyonrails.org/classes/ActiveRecord/Enum.html">Rails docs</a>:
</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Conversation</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">enum</span> <span class="ss">status</span><span class="p">:</span> <span class="o">[</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:archived</span> <span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># conversation.update! status: 0</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">active!</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">active?</span> <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span>  <span class="c1"># =&gt; &quot;active&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># conversation.update! status: 1</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">archived!</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">archived?</span> <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span>    <span class="c1"># =&gt; &quot;archived&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># conversation.update! status: 1</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;archived&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># conversation.update! status: nil</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">nil?</span> <span class="c1"># =&gt; true</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span>      <span class="c1"># =&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>
<p>
So what&#8217;s going on in terms of Ruby meta-programming?
</p>

<p>
For all the enum values declared for <code>Conversation</code>, methods are created in the
following forms. Let&#8217;s use the model Conversation, column &#8220;status&#8221;, and the enum &#8220;active&#8221; for this exampl:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">method</th>
<th scope="col" class="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left"><code>self.status</code></td>
<td class="left">Returns enum <b>string</b> value (not symbol, and not <b>integer</b> db value)</td>
</tr>

<tr>
<td class="left"><code>self.status=&lt;enum_string_value or integer_value&gt;</code></td>
<td class="left">Set the status to corresponding enum integer value using either a string, symbol, or integer. If you use an invalid value, you get an ArgumentError. String/symbol is converted to corresponding integer value.</td>
</tr>

<tr>
<td class="left"><code>self.active!</code></td>
<td class="left">Sets the status enum to &#8220;active&#8221;. This syntax is a bit confusing in that you don&#8217;t see the attribute you&#8217;re assigning! ArgumentError if invalid enum.</td>
</tr>

<tr>
<td class="left"><code>self.active?</code></td>
<td class="left">equivalent to (<code>self.status =</code> &#8220;active&#8221;<code>), and *not* equivalent to (=self.status =</code> :active=) due to symbols not being equal to strings!</td>
</tr>

<tr>
<td class="left"><code>Conversation.active</code></td>
<td class="left">equivalent to <code>Conversation.where(status: "active")</code>. Again, it&#8217;s a bit confusing not to see the column being queried.</td>
</tr>

<tr>
<td class="left"><code>Conversation.statuses</code></td>
<td class="left">Mapping of symbols to ordinal values <code>{ "active" \=&gt; 0, "archived" \=&gt; 1 }</code>, of type <code>HashWithIndifferentAccess</code>, meaning you can use symbols or strings</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Default Values for Enums</h3>
<div class="outline-text-3" id="text-1-1">
<p>
As the docs say, it&#8217;s a good idea to use the default value from the database declaration,  like:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:conversations</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<p>
More specifically, consider using the first declared status (enum db value zero)
be the default <i>and</i> to not allow null values. I&#8217;ve found that when I&#8217;ve allowed
null values in enums, it makes all my code more complicated. This is an example
of the <a href="http://robots.thoughtbot.com/rails-refactoring-example-introduce-null-object">Null Object Pattern</a>. Nulls in your data and checking for these in your
code will make your life more difficult! Instead, have an enum value for &#8220;I
don&#8217;t know&#8221; if that really is a possibility, and make that first value, which is
an index of zero, and you can set that as the database column default.
</p>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Queries on Enums</h3>
<div class="outline-text-3" id="text-1-2">
<p>
The docs say:
</p>
<blockquote>
<p>
In rare circumstances you might need to access the mapping directly. The mappings are exposed through a class method with the pluralized attribute name
</p>
</blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">statuses</span> <span class="c1"># =&gt; { &quot;active&quot; =&gt; 0, &quot;archived&quot; =&gt; 1 }</span>
</span></code></pre></td></tr></table></div></figure>

<p>
<b>This is not rare! This is critical!</b>
</p>

<p>
For example, suppose you want to query where the status is not &#8220;archived&#8221;:
</p>

<p>
You might be tempted to think that Rails will be smart enough to figure out that 
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;status &lt;&gt; ?&quot;</span><span class="p">,</span> <span class="s2">&quot;archived&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
Rails is not smart enough to know that the ? is for status and that is an enum.
So you have to use this syntax:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;status &lt;&gt; ?&quot;</span><span class="p">,</span> <span class="no">Conversation</span><span class="o">.</span><span class="n">statuses</span><span class="o">[</span><span class="ss">:archived</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
You might be tempted to think that this would work:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="ss">:archived</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>
That throws an <code>ArgumentError</code>. Rails wants an integer and not a symbol, and symbol does
not define <code>to_i</code>.
</p>

<p>
What&#8217;s worse is this one:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="s2">&quot;archived&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
The problem is that ActiveRecord sees that the enum column is of type integer
and calls <code>#to_i</code> on the value, so <code>archived.to_i</code> <b>gets converted to zero</b>. In
fact, <b>all your enums will get converted to zero!</b> And if you use the value of
the enum attribute on an ActiveRecord instance (say a Conversation object),
then you&#8217;re using a string value!
</p>

<p>
If you&#8217;re curious what the Rails source is, then take a look here: <a href="https://github.com/rails/rails/blob/master/activerecord/lib/active_record/type/integer.rb">ActiveRecord::Type::Integer</a>.
</p>

<p>
Here&#8217;s a guaranteed broken bit of code:
</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># my_conversation.status is a String!</span>
</span><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="n">my_conversation</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
You&#8217;d think that Rails would be clever enough to see that the key maps to an
enum and then check if the comparison value is a String, and then it would
<b>not</b> call <code>to_i</code> on the String! Instead, we are effectively running this code:
</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
An acceptable alternative to the last code example would be:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="no">Conersation</span><span class="o">.</span><span class="n">statuses</span><span class="o">[</span><span class="n">my_conversation</span><span class="o">.</span><span class="n">status</span><span class="o">]</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
If you left out the <code>not</code>, you could also do:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">my_conversation</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
However, I really would like to simply do these, <i>all of which <b>DO NOT</b> work</i>.:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="n">my_conversation</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="ss">:archived</span><span class="p">)</span>
</span><span class='line'><span class="no">Conversation</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="s2">&quot;archived&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">Pluck vs Map with Enums</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Here&#8217;s another subtle issue with enums.
</p>

<p>
Should these two lines of code give the same result or a different result:
</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">statuses_with_map</span> <span class="o">=</span> <span class="no">Conversation</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="ss">:status</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:status</span><span class="p">)</span>
</span><span class='line'><span class="n">statuses_with_pluck</span> <span class="o">=</span> <span class="no">Conversation</span><span class="o">.</span><span class="n">distinct</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:status</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>
It&#8217;s worth experimenting with this in the <a href="http://www.railsonmaui.com/blog/2014/08/17/pry-ruby-and-fun-with-the-hash-constructor/">Pry console</a>!
</p>

<p>
In the first case, with <code>map</code>, you get back an Array with 2 strings: <code>["active",
"archived"]</code>. In the second case, with <code>pluck</code>, you get back an Array with 2
integers: <code>[0, 1]</code>.
</p>

<p>
What&#8217;s going on here?
</p>

<p>
In the code where <code>map</code> calls the <code>status</code> method on each <code>Conversation</code> record,
the <code>status</code> method converts the database integer value into the corresponding
String value!
</p>

<p>
In the other code that uses <code>:pluck</code>, you get back the raw database value. It&#8217;s
arguable whether or not Rails should intelligently transform this value into the
string equivalent, since that is what is done in other uses of ActiveRecord.
Changing this would be problematic, as there could be code that depends on
getting back the numerical value.
</p>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><code>find_or_initialize_by</code>, oh my!!!</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Let&#8217;s suppose we have this persisted in the database:
</p>

<pre class="example">
Conversation {
  :id =&gt; 18,
  :user =&gt; 25            
  :status =&gt; "archived" (1 in database)
}
</pre>

<p>
And then we do a <code>find_or_initialize_by</code>: 
</p>

<pre class="example">
[47] (pry) main: 0&gt; conversation = Conversation.find_or_initialize_by(user: 25, status: "archived")
  Conversation Load (4.6ms)  SELECT  "conversations".* FROM "conversations"
    WHERE "conversations"."user_id" = 25
       AND "conversations"."status" = 0 LIMIT 1
#&lt;Conversation:&gt; {
         :id =&gt; nil,
    :user_id =&gt; 25,
     :status =&gt; "archived"
}
</pre>

<p>
We got <code>nil</code> for <code>:id</code>, meaning that we&#8217;re creating a new record. Wouldn&#8217;t you
expect to find the existing record? Well, maybe not given the way that
<code>ActiveRecord.where</code> works, per the above discussion.
</p>

<p>
Next, the status on the new record is created with &#8220;archived&#8221;, which is value 1.
Hmmm&#x2026;.If you look closely above, the query uses
</p>
<pre class="example">
AND "conversations"."status" = 0
</pre>

<p>
Let&#8217;s look at another example:
</p>

<pre class="example">
Conversation {
  :id =&gt; 19,
  :user =&gt; 26            
  :status =&gt; "active" (0 in database)
}
</pre>

<p>
And then we do a <code>find_or_initialize_by</code>: 
</p>

<pre class="example">
[47] (pry) main: 0&gt; conversation = Conversation.find_or_initialize_by(user: 26, status: "active")
  Conversation Load (4.6ms)  SELECT  "conversations".* FROM "conversations"
    WHERE "conversations"."user_id" = 26
      AND "conversations"."status" = 0 LIMIT 1
#&lt;Conversation:&gt; {
         :id =&gt; 19,
    :user_id =&gt; 26,
     :status =&gt; "active"
}
</pre>

<p>
Wow! Is this a source of subtle bugs and some serious yak shaving?
</p>

<p>
Note, the above applies equally to <code>ActiveRecord.find_or_create_by</code>.
</p>

<p>
It turns out that the Rails methods that allow creation of a record via a Hash
of attributes will convert the enum strings to the proper integer values, but
this is not case when querying!
</p>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">Rails Default Accessors For Setting Attributes</h3>
<div class="outline-text-3" id="text-1-5">
<p>
You may find it useful to know which Rails methods call the &#8220;Default Accessor&#8221;
versus just going to the database directly. That makes all the difference in
terms of whether or not you can/should use the string values for enums.
</p>

<p>
The key thing is that that &#8220;Uses Default Accessor&#8221; means that <b>string enums get converted to the correct database integer values.</b>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Method</th>
<th scope="col" class="left">Uses Default Accessor (converts string enums to integers!)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left"><code>attribute=</code></td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="left"><code>write_attribute</code></td>
<td class="left">No</td>
</tr>

<tr>
<td class="left"><code>update_attribute</code></td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="left"><code>attributes=</code></td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="left"><code>update</code></td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="left"><code>update_column</code></td>
<td class="left">No</td>
</tr>

<tr>
<td class="left"><code>update_columns</code></td>
<td class="left">No</td>
</tr>

<tr>
<td class="left"><code>Conversation::update</code></td>
<td class="left">Yes</td>
</tr>

<tr>
<td class="left"><code>Conversation::update_all</code></td>
<td class="left">No</td>
</tr>
</tbody>
</table>

<p>
For more information on this topic, see
</p>
<ol class="org-ol">
<li><a href="http://www.davidverhasselt.com/set-attributes-in-activerecord/">Different Ways to Set Attributes in ActiveRecord</a> by <a href="https://twitter.com/DavidVerhasselt">@DavidVerhasselt</a>.
</li>
<li><a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">Official API of ActiveRecord::Base</a>
</li>
<li><a href="http://api.rubyonrails.org/files/activerecord/README_rdoc.html">Official Readme of Active Record â€“ Object-relational mapping put on rails</a>.
</li>
</ol>

<p>
While these don&#8217;t mention Rails enums, it&#8217;s <b>critical</b> to understand that enums
create default accessors that do the mapping to and from Strings.
</p>

<p>
So when you call these methods, the <b>default accessors</b> are used:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;archived&quot;</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="c1"># prints &quot;archived&quot;</span>
</span></code></pre></td></tr></table></div></figure>

<p>
So keep in mind when those default accessors are used per the above table.
</p>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">Deep Dive: Enum Source</h3>
<div class="outline-text-3" id="text-1-6">
<p>
If you look at the Rails <a href="https://github.com/rails/rails/blob/877ea784e4cd0d539bdfbd15839ae3d28169b156/activerecord/lib/active_record/enum.rb#L82">source code for ActiveRecord::Enum</a>, you can see this at
line 91, for the setter of the enum (I added some comments):
</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">_enum_methods_module</span><span class="o">.</span><span class="n">module_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># def status=(value) self[:status] = statuses[value] end</span>
</span><span class='line'>  <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">enum_values</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="c1"># set the db value to the integer value for the enum</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">enum_values</span><span class="o">[</span><span class="n">value</span><span class="o">]</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">enum_values</span><span class="o">.</span><span class="n">has_value?</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="c1"># values contains the integer</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="c1"># enum_values did not have the key or value passed</span>
</span><span class='line'>      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;&#39;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; is not a valid </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
From this definition, you see that both of these work:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;active&quot;</span>
</span><span class='line'><span class="n">conversation</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Here&#8217;s the definition for the getter, which I&#8217;ve edited a bit for illustrative
purposes:
</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># def status() statuses.key self[:status] end</span>
</span><span class='line'><span class="n">define_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">db_value</span> <span class="o">=</span> <span class="nb">self</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="c1"># such as 0 or 1</span>
</span><span class='line'>  <span class="n">enum_values</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">db_value</span><span class="p">)</span> <span class="c1"># the key value, like &quot;archived&quot; for db_value 1</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">Recommendations to the Rails Core Team</h3>
<div class="outline-text-3" id="text-1-7">
<p>
In response to this issue, I submitted this github issue:
<a href="https://github.com/rails/rails/issues/17226">Rails where query should see value is an enum and convert a string #17226</a>
</p>
<ol class="org-ol">
<li>@Bounga and @rafaelfranca on Github suggest that we can&#8217;t automatically
convert enum string values in queries. I think that is true for converting
cases of a <code>?</code> or a named param, but I suspect that a quick map lookup to see
that the attribute is an enum, and a string is passed, and then converting
the string value to an integer is the right thing to do for 2 reasons:
<ol class="org-ol">
<li>This is the sort of &#8220;magic&#8221; that I expect from Rails.
</li>
<li>Existing methods <code>find_or_initialize_by</code> and <code>find_or_create_by</code> will
result in obscure bugs when string params are passed for enums.
</li>
</ol>
<p>
However, it&#8217;s worth considering if all default accessor methods (setters)
should be consistently be called for purposes of passing values in a map to
such methods. I would venture that Rails enums are some Rails provided magic,
and thus they should have a special case. If this shouldn&#8217;t go into Rails,
then possibly a gem extension could provide a method like
<code>Model.where_with_enum</code> which would convert a String into the proper
numerical value for the enum. I&#8217;m not a huge fan of the generated Model
scopes for enums, as <b>I like to see what database field is being queried
against.</b>
</p>
</li>
<li>Aside from putting automatic conversion of the enum hash attributes, I
recommend we change the automatic conversion of Strings to integers to use
the stricter <code>Integer(some_string)</code> rather than <code>some_string.to_i</code>. The
difference is considerable, <code>String#to_i</code> is extremely permissive. Try it in
a console. With the <code>to_i</code> method, any number characters at the beginning of
the String are converted to an Integer. If the first character is not a
number, <b>0 is returned</b>, which is almost certainly a default enum value.
Thus, this simple change would make it <b>extremely</b> clear when an enum string
is improperly used. I would guess that this would make some existing code
crash, but in all circumstances for a valid reason. As to whether this change
should be done for all integer attributes is a different discussion, as that
could have backwards compatibility ramifications. This change would require changing the tests in <a href="https://github.com/rails/rails/blob/master/activerecord/test/cases/types_test.rb">ActiveRecord::ConnectionAdapters::TypesTest</a>. For example, this test:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">assert_equal</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="o">.</span><span class="n">type_cast_from_user</span><span class="p">(</span><span class="s1">&#39;bad&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>
would change to throw an exception, unless the cases are restricted to using
Integer.new() for enums. It is inconsistent that some type conversions throw
exceptions, such as converting a symbol to an integer. Whether or not they
should is much larger issue. In the case of enums, <b>I definitely believe that proper enum string value should not silently convert to zero every time.</b>
</p>
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Conclusion</h2>
<div class="outline-text-2" id="text-2">
<p>
I hope this article has convinced you that it&#8217;s worth understanding Ruby as much
as it is to understand Rails. Additionally, the new Enum feature in 4.1 requires
some careful attention!
</p>

<p>
Thanks to Hack Hands for supporting the development of this content. You can
find <a href="https://hackhands.com/ruby-on-enums-queries-and-rails-4-1/">a copy of this article in their blog</a>. 
</p>
</div>
</div>
<div id="discourse-comments"></div>
<script type="text/javascript">
  var discourseUrl = "http://forum.shakacode.com/",
      discourseEmbedUrl = "http://www.railsonmaui.com//blog/2014/10/22/enums-and-queries-in-rails-4-dot-1/";
  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
      d.src = discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Justin Gordon</span></span>

      




<time class='entry-date' datetime='2014-10-22T19:23:02-10:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>7:23 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>rails</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.railsonmaui.com//blog/2014/10/22/enums-and-queries-in-rails-4-dot-1/" data-via="railsonmaui" data-counturl="http://www.railsonmaui.com//blog/2014/10/22/enums-and-queries-in-rails-4-dot-1/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/10/08/adding-a-js-library-when-using-webpack/" title="Previous Post: Adding a JS LIbrary to a Ruby on Rails Project When Using Webpack">&laquo; Adding a JS LIbrary to a Ruby on Rails Project When Using Webpack</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/01/25/masking-pii-with-ruby-gsub-with-regular-expression-named-match-groups/" title="Next Post: Masking PII with Ruby gsub with Regular Expression Named Match Groups, Non-Greedy">Masking PII with Ruby gsub with Regular Expression Named Match Groups, Non-Greedy &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h2>About Me</h2>
  <p>I&#8217;m Justin Gordon, a Ruby on Rails + ReactJs consultant based in Maui. Full
  stack development is my passion. Feel free to contact me
  at <a href='mailto:justin@railsonmaui.com'>justin@railsonmaui.com</a>. Read
  more <a href='http://www.railsonmaui.com/about'>about me</a>. Find me
  on <a href='http://www.linkedin.com/pub/justin-gordon/1/a41/286'>Linked In</a>
  and <a href='https://www.facebook.com/railsonmaui'>Facebook</a> and
  <a href="https://github.com/justin808/">github/justin808</a>.
  </p><p>
  FYI, I&#8217;m doing many more micro-blog articles on
  the <a href="http://forum.railsonmaui.com">Rails on Maui Forum</a>.
  I do my best to be sure every question gets
  answered. If you join, you can get periodic updates of recent topics.
  </p><p>
  Want to partner on remote telecommuting for Rails + ReactJs projects? You need
  passion and skills. <a href=http://forum.railsonmaui.com/t/railsonmaui-is-hiring-and-partnering-part-time-remote-is-ok/156>Click here</a>.
  </p>
</section>

<section>
  <div>
    <a href="http://twitter.com/railsonmaui" class="twitter-follow-button" data-show-count="">Follow @railsonmaui</a>
  </div>
</section>

<section>
  <h2 class='products-i-use'>Products I Use!</h2>
  <A HREF="https://www.loggly.com/docs/rails-logs/"><IMG SRC="/images/rails-logging-loggly-260x87.jpg" WIDTH=260 HEIGHT=87 ALT="Rails Logging Loggly"></A>
  <div id='rubymine-tag'/>
  <NOSCRIPT>
    <A HREF="http://ad.doubleclick.net/ddm/jump/N3643.1922313RAILSONMAUI1/B8257337.116550223;sz=260x87;ord=[timestamp]?">
    <IMG SRC="http://ad.doubleclick.net/ddm/ad/N3643.1922313RAILSONMAUI1/B8257337.116550223;sz=260x87;ord=[timestamp]?" WIDTH=260 HEIGHT=87 ALT="RubyMine"></A>
  </NOSCRIPT>
</section>
<section>
  <h2>Recent Posts</h2>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/25/masking-pii-with-ruby-gsub-with-regular-expression-named-match-groups/">Masking PII With Ruby Gsub With Regular Expression Named Match Groups, Non-Greedy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/22/enums-and-queries-in-rails-4-dot-1/">Enums and Queries in Rails 4.1, and Understanding Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/08/adding-a-js-library-when-using-webpack/">Adding a JS LIbrary to a Ruby on Rails Project When Using Webpack</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/03/integrating-webpack-and-the-es6-transpiler-into-an-existing-rails-project/">Fast Rich Client Rails Development With Webpack and the ES6 Transpiler</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/29/react-on-rails-4-dot-2-simple-tutorial/">React on Rails Tutorial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/28/gogaruco-pictures-2014/">Golden Gate Ruby Conference (GoGaRuCo) Pictures 2014</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/28/storing-or-excluding-node-modules-in-rails-git-repositories/">Storing or Excluding Node Modules in Rails Git Repositories</a>
      </li>
    
  </ul>
</section>

<section>
  <h2>GitHub Repos</h2>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/justin808">@justin808</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'justin808',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h2>
    <a href="https://plus.google.com/102850786590145072082?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h2>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Justin Gordon -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
